<!doctype html>
<html lang="sv">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Tour de Nerja – Startsida</title>

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root{
  --bg:#0a0a0b;
  --text:#f4f4f5;
  --muted:#a1a1aa;
  --line:rgba(255,255,255,.12);
  --surface:rgba(255,255,255,.03);
  --radius:22px;
  --max:1080px;
  --header-h:56px;

  --bar-bg:rgba(255,255,255,.06);
  --bar-line:rgba(255,255,255,.10);
  --bar-split:rgba(0,0,0,.55);
  --bar-mid:rgba(255,255,255,.35);

  --team-a:#7c1d1d;
  --team-b:#1e3a8a;
}

*{box-sizing:border-box}
body{
  margin:0;
  font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;
  background:var(--bg);
  color:var(--text);
}
a{color:inherit;text-decoration:none}
.wrap{
  max-width:var(--max);
  margin:0 auto;
  padding:22px 18px 80px;
}

/* ===== Header ===== */
header{
  position:sticky;
  top:0;
  z-index:10;
  height:var(--header-h);
  background:rgba(10,10,11,.78);
  backdrop-filter:blur(10px);
  border-bottom:1px solid var(--line);
  overflow:visible;
}
.top{
  position:relative;
  max-width:var(--max);
  height:100%;
  margin:0 auto;
  padding:0 18px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
}
.brand{
  position:absolute;
  left:18px;
  top:0;
  z-index:3;
}
.logo{
  height:100px;
  width:auto;
  display:block;
  position:relative;
  top:18px;
}
nav{
  display:flex;
  gap:10px;
  margin-left:140px;
  align-items:center;
}
nav a{
  padding:10px 12px;
  border-radius:16px;
  color:var(--muted);
  white-space:nowrap;
}
nav a:hover{
  background:rgba(255,255,255,.06);
  color:var(--text);
}

/* ===== Hero ===== */
.hero{padding:72px 0 18px}
h1{
  margin:0;
  font-size:clamp(2.2rem,4.6vw + .4rem,4.6rem);
  line-height:.98;
}
.lead{
  margin:14px 0 0;
  color:var(--muted);
  max-width:60ch;
  line-height:1.7;
  font-size:1rem;
}

/* ===== Block ===== */
.block{
  margin-top:18px;
  border:1px solid var(--line);
  border-radius:var(--radius);
  background:var(--surface);
  padding:16px;
}

/* ===== Poängbar ===== */
.bar-head{
  display:flex;
  justify-content:space-between;
  align-items:flex-end;
  gap:12px;
  margin-bottom:10px;
}
.bar-team{
  font-weight:700;
  letter-spacing:.2px;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
  max-width:48%;
}
.bar-team.right{text-align:right}
.bar{
  position:relative;
  border:1px solid var(--bar-line);
  border-radius:16px;
  background:rgba(0,0,0,.18);
  overflow:hidden;
}
.bar-grid{
  display:grid;
  grid-template-columns:repeat(14,1fr);
  height:52px;
}
.seg{
  position:relative;
  display:flex;
  align-items:center;
  justify-content:center;
  background:var(--bar-bg);
  border-right:1px solid var(--bar-split);
}
.seg:last-child{border-right:0}
.seg-text{
  position:relative;
  z-index:2;
  font-weight:700;
  font-size:1.10rem;
  letter-spacing:.2px;
  line-height:1;
  user-select:none;
  pointer-events:none;
  color:var(--text);
  text-shadow:0 1px 10px rgba(0,0,0,.6);
}
.seg.a{background:var(--team-a)}
.seg.b{background:var(--team-b)}
.seg.half.a{ background:linear-gradient(to right,var(--team-a) 50%,var(--bar-bg) 50%); }
.seg.half.b{ background:linear-gradient(to left,var(--team-b) 50%,var(--bar-bg) 50%); }
.bar::after{
  content:"";
  position:absolute;
  top:0; bottom:0;
  left:50%;
  width:2px;
  background:var(--bar-mid);
  transform:translateX(-1px);
}

/* ===== Matchbox ===== */
.roundtabs{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  justify-content:center;
  margin:6px 0 10px;
}
.roundtab{
  font-family:inherit;
  padding:10px 14px;
  border-radius:16px;
  border:1px solid var(--line);
  background:rgba(255,255,255,.06);
  color:var(--text);
  font-weight:600;
  cursor:pointer;
  white-space:nowrap;
}
.roundtab:hover{filter:brightness(1.06)}
.roundtab[aria-pressed="true"]{ background:rgba(255,255,255,.10); }

.matches-sub{
  color:var(--muted);
  font-weight:700;
  font-size:1.10rem;
  text-align:center;
  margin:2px 0 14px;
  white-space:normal;
}
.matches-list{ display:grid; gap:14px; }
.empty{
  border:1px dashed rgba(255,255,255,.18);
  background:rgba(0,0,0,.10);
  border-radius:16px;
  padding:14px 12px;
  text-align:center;
  color:var(--muted);
  font-weight:800;
}

/* ===== Matchbar ===== */
.matchbar{
  border-radius:22px;
  overflow:hidden;
  border:1px solid rgba(0,0,0,.35);
  box-shadow:0 10px 26px rgba(0,0,0,.35);
  background: var(--mb-bg, rgba(255,255,255,.12));
}
.matchbar-head{
  padding:10px 14px;
  background: rgba(255,255,255,.16);
  border-bottom:1px solid rgba(0,0,0,.18);
  text-align:center;
  font-weight:600;
  letter-spacing:.2px;
  color: rgba(255,255,255,.95);
}
.matchbar-body{
  position:relative;
  display:grid;
  grid-template-columns: 1fr 220px 1fr;
  align-items:center;
  gap:12px;
  padding:16px 18px;
  min-height:82px;
  overflow:hidden;
  --mid-gap: 140px;
}
.matchbar-body::before,
.matchbar-body::after{
  content:"";
  position:absolute;
  top:0; bottom:0;
  pointer-events:none;
  z-index:0;
}
.matchbar-body.fill-a::before{
  left:0;
  width:calc(50% - (var(--mid-gap) / 2));
  background: var(--team-a);
  clip-path:polygon(0 0, 92% 0, 100% 50%, 92% 100%, 0 100%);
}
.matchbar-body.fill-b::after{
  right:0;
  width:calc(50% - (var(--mid-gap) / 2));
  background: var(--team-b);
  clip-path:polygon(8% 0, 100% 0, 100% 100%, 8% 100%, 0 50%);
}
.matchbar-body.fill-d::before{
  left:0;
  width:calc(50% - (var(--mid-gap) / 2));
  background: rgba(0,0,0,.22);
  clip-path:polygon(0 0, 92% 0, 100% 50%, 92% 100%, 0 100%);
}
.matchbar-body.fill-d::after{
  right:0;
  width:calc(50% - (var(--mid-gap) / 2));
  background: rgba(0,0,0,.22);
  clip-path:polygon(8% 0, 100% 0, 100% 100%, 8% 100%, 0 50%);
}
.matchside, .matchcenter{ position:relative; z-index:1; }
.matchside{display:flex;flex-direction:column;gap:6px;min-width:0;}
.matchside.left{align-items:flex-start;text-align:left;}
.matchside.right{align-items:flex-end;text-align:right;}
.matchteam{
  font-weight:700;
  font-size:1.10rem;
  line-height:1.1;
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
  color: rgba(255,255,255,.95);
}
.matchplayers{
  font-weight:600;
  opacity:.9;
  font-size:0.9rem;
  line-height:1.15;
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
  color: rgba(255,255,255,.95);
}
.matchcenter{display:flex;justify-content:center;align-items:center;text-align:center;}
.matchresult{
  font-weight:700;
  font-size:1.50rem;
  letter-spacing:.4px;
  line-height:1;
  padding:6px 0;
  min-width:140px;
  color: rgba(255,255,255,.95);
}

/* ===== Statistikbox ===== */
.tabs{
  margin-top:8px;
  display:flex;
  justify-content:center;
  gap:10px;
  flex-wrap:wrap;
}
.tabbtn{
  padding:10px 14px;
  border-radius:16px;
  border:1px solid var(--line);
  background:rgba(255,255,255,.06);
  color:var(--text);
  font-weight:700;
  cursor:pointer;
}
.tabbtn.is-active{background:rgba(255,255,255,.10)}

.table-wrap{padding:0;margin:0;background:transparent;border:0}
.scoretable{
  width:100%;
  border-collapse:separate;
  border-spacing:0;
  border:0;
  background:transparent;
  font-variant-numeric: tabular-nums;
  min-width: 720px;
}
.scoretable th, .scoretable td{
  padding:10px 10px;
  border-bottom:1px solid rgba(255,255,255,.08);
  font-size:.95rem;
  background:transparent;
  text-align:center;
}
.scoretable thead th{color:var(--muted);font-weight:700}
.scoretable tbody tr:last-child td{border-bottom:0}
.scoretable th:first-child, .scoretable td:first-child{text-align:left}
.team-dot{
  display:inline-block;
  width:10px;height:10px;border-radius:999px;
  margin-right:8px;vertical-align:middle;
  border:1px solid rgba(255,255,255,.25);
}

/* sticky första kolumnen + scroll */
.table-wrap{ overflow-x:auto; -webkit-overflow-scrolling:touch; }
.scoretable th:first-child,
.scoretable td:first-child{
  position:sticky;
  left:0;
  background: rgba(10,10,11,.92);
  backdrop-filter: blur(8px);
  z-index:2;
}
.scoretable thead th:first-child{ z-index:3; }

.tiebreak-note{
  margin-top:10px;
  color:var(--muted);
  font-size:.80rem;
  font-weight:600;
  text-align:left;
}

@media(max-width:720px){
  header{height:auto;}
  .top{
    padding:10px 14px;
    gap:10px;
    flex-wrap:wrap;
    justify-content:space-between;
  }
  .brand{position:static;}
  .logo{height:56px;top:0;}
  nav{
    margin-left:0;
    width:100%;
    gap:8px;
    flex-wrap:wrap;
  }
  nav a{
    flex:1 1 auto;
    text-align:center;
    padding:10px 10px;
  }
  .hero{padding-top:56px}
  .bar-grid{height:44px}

  .matchbar-body{
    grid-template-columns: 1fr 160px 1fr;
    padding:14px 14px;
    --mid-gap: 120px;
    min-height:76px;
  }
  .matchresult{font-size:1.6rem;min-width:110px;}
  .matchteam{font-size:1rem;}
  .matchplayers{font-size:.88rem;}

  .scoretable th, .scoretable td{ padding:8px 8px; font-size:.9rem; }
}
</style>
</head>

<body>
<header>
  <div class="top">
    <a class="brand" href="#"><img class="logo" src="tour-de-nerja-logo.png" alt=""></a>
    <nav aria-label="Meny">
      <a href="#tourdenerja">Tour de Nerja</a>
      <a href="#statistik">Statistik</a>
    </nav>
  </div>
</header>

<main class="wrap" id="tourdenerja">
  <section class="hero">
    <h1>Tour de Nerja 2026</h1>
    <p class="lead">Matchplay, lagfokus och tillräckligt många sidobet för att göra matte till en kontaktsport.</p>
  </section>

  <section class="block" id="scorebarBlock">
    <div class="bar-head" aria-label="Lag">
      <div class="bar-team" id="teamAName">Lag A</div>
      <div class="bar-team right" id="teamBName">Lag B</div>
    </div>

    <div id="scorebarEmpty" style="display:none"></div>

    <div class="bar" id="scorebar" aria-label="Poängbar">
      <div class="bar-grid" id="barGrid">
        <span class="seg"><span class="seg-text"></span></span>
        <span class="seg"><span class="seg-text"></span></span>
        <span class="seg"><span class="seg-text"></span></span>
        <span class="seg"><span class="seg-text"></span></span>
        <span class="seg"><span class="seg-text"></span></span>
        <span class="seg"><span class="seg-text"></span></span>
        <span class="seg"><span class="seg-text"></span></span>

        <span class="seg"><span class="seg-text"></span></span>
        <span class="seg"><span class="seg-text"></span></span>
        <span class="seg"><span class="seg-text"></span></span>
        <span class="seg"><span class="seg-text"></span></span>
        <span class="seg"><span class="seg-text"></span></span>
        <span class="seg"><span class="seg-text"></span></span>
        <span class="seg"><span class="seg-text"></span></span>
      </div>
    </div>
  </section>

  <section class="block" id="matchesBlock">
    <div class="roundtabs" id="roundTabs" aria-label="Ronder"></div>
    <div class="matches-sub" id="matchesSub">—</div>
    <div class="matches-list" id="matchesList"></div>
  </section>

  <section class="block" id="publicStatsBox">
    <div class="tabs" role="tablist" aria-label="Statistikflikar">
      <button class="tabbtn is-active" type="button" role="tab" aria-selected="true"
              aria-controls="lagStatsBlock" id="tab-lagstats">Lagstatistik</button>
      <button class="tabbtn" type="button" role="tab" aria-selected="false"
              aria-controls="playerStatsBlock" id="tab-playerstats">Spelarstatistik</button>
    </div>

    <section class="block" id="lagStatsBlock" style="margin-top:14px">
      <div class="table-wrap">
        <table class="scoretable" id="lagStatsTable">
          <thead>
            <tr>
              <th title="Lag">Lag</th>
              <th title="Spelade matcher">SM</th>
              <th title="Parmatchvinster">PV</th>
              <th title="Singelmatchvinster">SV</th>
              <th title="Delade matcher">D</th>
              <th title="Förlorade matcher">F</th>
              <th title="Matchhålvinstskillnad">+/-</th>
              <th title="Poäng">P</th>
            </tr>
          </thead>
          <tbody id="lagStatsBody"></tbody>
        </table>
      </div>

      <div class="tiebreak-note">
        Vid lika poäng avgör:
        <br>1) Matchhålvinstskillnad (+/-).
        <br>2) Flest vunna singelmatcher (SV).
      </div>
    </section>

    <section class="block" id="playerStatsBlock" style="display:none; margin-top:14px">
      <div class="table-wrap">
        <table class="scoretable" id="playerStatsTable">
          <thead>
            <tr>
              <th title="Spelare">Spelare</th>
              <th title="Spelade matcher">SM</th>
              <th title="Parmatchvinster">PV</th>
              <th title="Singelmatchvinster">SV</th>
              <th title="Delade matcher">D</th>
              <th title="Förlorade matcher">F</th>
              <th title="Birdies(1,5p)">B</th>
              <th title="Eagles(3,5p)">E</th>
              <th title="Albatross(30p)">A</th>
              <th title="Hole in One(20p)">HIO</th>
              <th title="Närmast flagg(1,5p)">NF</th>
              <th title="Längsta drive(1,5p)">LD</th>
              <th title="Poäng">P</th>
              <th title="Finalfördel">FF</th>
            </tr>
          </thead>
          <tbody id="playerStatsBody"></tbody>
        </table>
      </div>

      <div class="tiebreak-note">
        Vid lika poäng avgör:
        <br>1) Flest singelmatchvinster (SV).
        <br>2) Flest parmatchvinster (PV).
        <br>3) Flest albatross (A).
        <br>4) Flest HIO.
        <br>5) Flest eagles (E).
        <br>6) Flest birdies (B).
      </div>
    </section>

    <section id="statistik" style="height:1px;"></section>
  </section>
</main>

<script>
const SUPABASE_URL = "https://bedouordcrbaucvlnwkw.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJlZG91b3JkY3JiYXVjdmxud2t3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk2MzExMzMsImV4cCI6MjA4NTIwNzEzM30.mv9BVpT5NR0zsY5U5uRLADpDZZxDNZk1e8La1UzzQmU";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

(function(){

  function setEmpty(el, text){
    el.innerHTML = `<div class="empty">${text}</div>`;
  }

  function fmtScore(n){
    const x = Number(n) || 0;
    return (x % 1 === 0) ? String(x) : String(x).replace('.', ',');
  }

  function fmtPts(x){
    const n = Number(x) || 0;
    return (n % 1 === 0) ? String(n) : n.toFixed(1).replace('.', ',');
  }

  function teamColorById(state, teamId){
    const t = (state.teams || []).find(x => x && x.id === teamId);
    return t?.color || 'rgba(255,255,255,.22)';
  }

  function sanitizeState(state){
    state = state && typeof state === 'object' ? state : {};
    state.teams   = Array.isArray(state.teams)   ? state.teams   : [];
    state.players = Array.isArray(state.players) ? state.players : [];
    state.rounds  = Array.isArray(state.rounds)  ? state.rounds  : [];
    state.matches = Array.isArray(state.matches) ? state.matches : [];
    state.stats   = (state.stats && typeof state.stats === 'object') ? state.stats : {};
    return state;
  }

  async function loadState(){
    try{
      const { data, error } = await sb
        .from('app_state')
        .select('data')
        .eq('id', 'main')
        .single();

      if(error || !data || !data.data){
        return sanitizeState({teams:[], players:[], rounds:[], matches:[], stats:{}});
      }

      const d = data.data || {};

      // ✅ NYCKELFIX: behåll stats från admin
      return sanitizeState({
        teams:   Array.isArray(d.teams)   ? d.teams   : [],
        players: Array.isArray(d.players) ? d.players : [],
        rounds:  Array.isArray(d.rounds)  ? d.rounds  : [],
        matches: Array.isArray(d.matches) ? d.matches : [],
        stats:   (d.stats && typeof d.stats === 'object') ? d.stats : {}
      });

    }catch(e){
      return sanitizeState({teams:[], players:[], rounds:[], matches:[], stats:{}});
    }
  }

  // =========================
  // SCOREBAR (fortfarande baserat på stängda matcher)
  // =========================
  function contrastTextColor(bg){
    const s = String(bg || '').trim();
    if(s.startsWith('#')){
      let r,g,b;
      if(s.length === 4){
        r = parseInt(s[1]+s[1],16);
        g = parseInt(s[2]+s[2],16);
        b = parseInt(s[3]+s[3],16);
      }else if(s.length === 7){
        r = parseInt(s.slice(1,3),16);
        g = parseInt(s.slice(3,5),16);
        b = parseInt(s.slice(5,7),16);
      }else return '#fff';
      return _contrastFromRgb(r,g,b);
    }
    const m = s.match(/rgba?\(\s*([\d.]+)\s*,\s*([\d.]+)\s*,\s*([\d.]+)(?:\s*,\s*[\d.]+)?\s*\)/i);
    if(m){
      const r = Math.max(0, Math.min(255, Number(m[1])));
      const g = Math.max(0, Math.min(255, Number(m[2])));
      const b = Math.max(0, Math.min(255, Number(m[3])));
      return _contrastFromRgb(r,g,b);
    }
    return '#fff';

    function _contrastFromRgb(r,g,b){
      const srgb = [r,g,b].map(v => {
        const x = v/255;
        return x <= 0.03928 ? x/12.92 : Math.pow((x+0.055)/1.055, 2.4);
      });
      const L = 0.2126*srgb[0] + 0.7152*srgb[1] + 0.0722*srgb[2];
      return (L > 0.52) ? '#000' : '#fff';
    }
  }

  function computeTeamPoints(state){
    const teams = state.teams || [];
    const teamA = teams[0] || null;
    const teamB = teams[1] || null;

    const out = {
      teamAName: teamA?.name || 'Lag A',
      teamBName: teamB?.name || 'Lag B',
      teamAColor: teamA?.color || '#7c1d1d',
      teamBColor: teamB?.color || '#1e3a8a',
      A: 0,
      B: 0
    };

    if(!teamA || !teamB) return out;

    (state.matches || []).forEach(m => {
      if(!m || !m.isClosed) return;
      const w = String(m?.book?.winner || '');
      if(w === 'A') out.A += 1;
      else if(w === 'B') out.B += 1;
      else if(w === 'D'){ out.A += 0.5; out.B += 0.5; }
    });

    return out;
  }

  function paintBarFromOutside(aPts, bPts){
    const grid = document.getElementById('barGrid');
    if(!grid) return;

    const segs = Array.from(grid.querySelectorAll('.seg'));
    if(segs.length !== 14) return;

    segs.forEach(s => { s.className = 'seg'; });

    const clamp = v => Math.max(0, Math.min(7, v));
    const a = clamp(Number(aPts) || 0);
    const b = clamp(Number(bPts) || 0);

    const aWhole = Math.floor(a);
    const aHalf  = (a - aWhole) >= 0.5;

    const bWhole = Math.floor(b);
    const bHalf  = (b - bWhole) >= 0.5;

    for(let k=0;k<aWhole;k++){
      const i = k;
      if(segs[i]) segs[i].classList.add('a');
    }
    if(aHalf){
      const i = aWhole;
      if(i <= 6 && segs[i]) segs[i].classList.add('half','a');
    }

    for(let k=0;k<bWhole;k++){
      const i = 13 - k;
      if(segs[i]) segs[i].classList.add('b');
    }
    if(bHalf){
      const i = 13 - bWhole;
      if(i >= 7 && segs[i]) segs[i].classList.add('half','b');
    }
  }

  async function renderScorebar(){
    const state = await loadState();
    const t = computeTeamPoints(state);

    const aName = document.getElementById('teamAName');
    const bName = document.getElementById('teamBName');
    const empty = document.getElementById('scorebarEmpty');
    const grid  = document.getElementById('barGrid');

    const hasTwoTeams = Array.isArray(state.teams) && state.teams.length >= 2;

    if(!hasTwoTeams){
      if(aName) aName.textContent = '—';
      if(bName) bName.textContent = '—';

      if(grid){
        const segs = Array.from(grid.querySelectorAll('.seg'));
        segs.forEach(s => {
          s.className = 'seg';
          const tx = s.querySelector('.seg-text');
          if(tx) tx.textContent = '';
        });
      }

      if(empty){
        empty.style.display = '';
        setEmpty(empty, 'Inga lag ännu. Lägg till två lag i Admin.');
      }
      return;
    }

    if(empty) empty.style.display = 'none';

    if(aName) aName.textContent = t.teamAName;
    if(bName) bName.textContent = t.teamBName;

    document.documentElement.style.setProperty('--team-a', t.teamAColor);
    document.documentElement.style.setProperty('--team-b', t.teamBColor);

    paintBarFromOutside(t.A, t.B);

    if(!grid) return;
    const segs = Array.from(grid.querySelectorAll('.seg'));
    if(segs.length !== 14) return;

    segs.forEach(s => {
      const tx = s.querySelector('.seg-text');
      if(tx) tx.textContent = '';
    });

    const leftText  = segs[0].querySelector('.seg-text');
    const rightText = segs[13].querySelector('.seg-text');

    if(leftText){
      leftText.textContent = fmtScore(t.A);
      leftText.style.color = contrastTextColor(t.teamAColor);
    }
    if(rightText){
      rightText.textContent = fmtScore(t.B);
      rightText.style.color = contrastTextColor(t.teamBColor);
    }
  }

  // =========================
  // MATCHBARS (oförändrat – visar matcher)
  // =========================
  function roundsSorted(state){
    return (state.rounds || []).slice().sort((a,b) => (a.date || '').localeCompare(b.date || ''));
  }

  function matchesForRound(state, roundId){
    return (state.matches || [])
      .filter(m => m && m.roundId === roundId)
      .slice()
      .sort((a,b) => (Number(a.no)||0) - (Number(b.no)||0));
  }

  function roundLabel(i, r){
    const no = i + 1;
    const bits = [];
    if(r?.date) bits.push(r.date);
    if(r?.course) bits.push(r.course);
    return `Runda ${no}` + (bits.length ? ` • ${bits.join(' – ')}` : '');
  }

  function matchTypeLabel(m){
    const t = String(m?.type || '').toLowerCase();
    if(t.includes('par')) return 'Bästboll';
    if(t.includes('sing')) return 'Singel';
    return m?.type ? String(m.type) : 'Singel';
  }

  function playerNameById(state, id){
    const p = (state.players || []).find(x => x && x.id === id);
    return p ? (p.name || '') : '';
  }

  function playersText(state, ids){
    const arr = Array.isArray(ids) ? ids.filter(Boolean) : [];
    const names = arr.map(id => playerNameById(state, id)).filter(Boolean);
    return names.length ? names.join(' / ') : '—';
  }

  function hasBothSidesPlayers(m){
    const aHas = Array.isArray(m?.teamA) && m.teamA.filter(Boolean).length > 0;
    const bHas = Array.isArray(m?.teamB) && m.teamB.filter(Boolean).length > 0;
    return aHas && bHas;
  }

  function matchStatusLabel(m){
    if(m?.isClosed === true) return 'Avslutad';
    if(hasBothSidesPlayers(m)) return 'Öppen';
    return 'Uppsatt';
  }

  function winnerForFill(m){
    if(m?.isClosed !== true) return '';
    const w = String(m?.book?.winner || '');
    if(w === 'A' || w === 'B' || w === 'D') return w;
    return '';
  }

  function resultTextForMatch(m){
    const closed = (m?.isClosed === true);

    if(!closed){
      if(!hasBothSidesPlayers(m)) return '-';
      return 'AS';
    }

    const w = String(m?.book?.winner || '');
    const wonOnHole = Number(m?.book?.wonOnHole) || 0;
    const up = Number(m?.book?.resultUp) || 0;

    if(w === 'D') return 'Delad';

    if(w === 'A' || w === 'B'){
      if(wonOnHole >= 1 && wonOnHole <= 17){
        const remaining = 18 - wonOnHole;
        return `${Math.max(1, up)}&${remaining}`;
      }
      if(wonOnHole === 18) return `${Math.max(1, up)}UP`;
      return `${Math.max(1, up)}UP`;
    }

    return 'AS';
  }

  function buildMatchBar(state, m){
    const bar = document.createElement('div');
    bar.className = 'matchbar';

    const head = document.createElement('div');
    head.className = 'matchbar-head';
    const no = Number(m?.no) || 0;
    head.textContent = `Match ${no || ''} - ${matchTypeLabel(m)} - ${matchStatusLabel(m)}`.trim();

    const body = document.createElement('div');
    body.className = 'matchbar-body';

    const wf = winnerForFill(m);
    if(wf === 'A') body.classList.add('fill-a');
    else if(wf === 'B') body.classList.add('fill-b');
    else if(wf === 'D') body.classList.add('fill-d');

    const left = document.createElement('div');
    left.className = 'matchside left';
    left.innerHTML = `
      <div class="matchteam">${(state.teams?.[0]?.name) || 'Lagnamn'}</div>
      <div class="matchplayers">${playersText(state, m?.teamA)}</div>
    `;

    const center = document.createElement('div');
    center.className = 'matchcenter';
    center.innerHTML = `<div class="matchresult">${resultTextForMatch(m)}</div>`;

    const right = document.createElement('div');
    right.className = 'matchside right';
    right.innerHTML = `
      <div class="matchteam">${(state.teams?.[1]?.name) || 'Lagnamn'}</div>
      <div class="matchplayers">${playersText(state, m?.teamB)}</div>
    `;

    body.appendChild(left);
    body.appendChild(center);
    body.appendChild(right);

    bar.appendChild(head);
    bar.appendChild(body);

    return bar;
  }

  async function renderRoundsAndMatches(){
    const state = await loadState();

    const tabs = document.getElementById('roundTabs');
    const sub  = document.getElementById('matchesSub');
    const list = document.getElementById('matchesList');
    if(!tabs || !sub || !list) return;

    const rounds = roundsSorted(state);

    if(rounds.length === 0){
      tabs.innerHTML = '';
      sub.textContent = 'Inga ronder ännu.';
      setEmpty(list, 'Inga matcher ännu. Lägg till en rond i Admin.');
      return;
    }

    let selected = tabs.getAttribute('data-selected') || '';
    if(!selected || !rounds.some(r => r.id === selected)){
      selected = rounds[0].id;
      tabs.setAttribute('data-selected', selected);
    }

    tabs.innerHTML = '';
    rounds.forEach((r, i) => {
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'roundtab';
      btn.textContent = `Runda ${i+1}`;
      btn.setAttribute('aria-pressed', (r.id === selected) ? 'true' : 'false');
      btn.title = roundLabel(i, r);
      btn.addEventListener('click', async () => {
        tabs.setAttribute('data-selected', r.id);
        await renderRoundsAndMatches();
      });
      tabs.appendChild(btn);
    });

    const roundIndex = rounds.findIndex(r => r.id === selected);
    const selectedRound = rounds[roundIndex];
    const ms = matchesForRound(state, selected);

    sub.textContent = `${roundLabel(roundIndex, selectedRound)} • ${ms.length} matcher`;

    list.innerHTML = '';
    if(ms.length === 0){
      setEmpty(list, 'Inga matcher i denna rond ännu.');
      return;
    }

    ms.forEach(m => list.appendChild(buildMatchBar(state, m)));
  }

  // =========================
  // STATISTIK – REN SPEGLING AV ADMIN
  // =========================
  function renderLagStatsMirror(state){
    const body = document.getElementById('lagStatsBody');
    if(!body) return;

    body.innerHTML = '';

    const rows = state?.stats?.teamRows;
    if(!Array.isArray(rows) || rows.length === 0){
      const tr = document.createElement('tr');
      const td = document.createElement('td');
      td.colSpan = 8;
      td.textContent = 'Ingen lagstatistik ännu.';
      td.style.textAlign = 'left';
      td.style.color = 'var(--muted)';
      tr.appendChild(td);
      body.appendChild(tr);
      return;
    }

    for(const r of rows){
      const tr = document.createElement('tr');

      const tdName = document.createElement('td');
      const dot = document.createElement('span');
      dot.className = 'team-dot';
      dot.style.background = teamColorById(state, r.teamId || r.id);
      const name = document.createElement('span');
      name.textContent = r.name || '';
      tdName.appendChild(dot);
      tdName.appendChild(name);
      tr.appendChild(tdName);

      const cells = [
        r.SM, r.PV, r.SV, r.D, r.F, r.PM, fmtPts(r.P)
      ];

      cells.forEach(v => {
        const td = document.createElement('td');
        td.textContent = String(v ?? 0).replace('.', ',');
        tr.appendChild(td);
      });

      body.appendChild(tr);
    }
  }

  function renderPlayerStatsMirror(state){
    const body = document.getElementById('playerStatsBody');
    if(!body) return;

    body.innerHTML = '';

    const rows = state?.stats?.playerRows;
    if(!Array.isArray(rows) || rows.length === 0){
      const tr = document.createElement('tr');
      const td = document.createElement('td');
      td.colSpan = 14;
      td.textContent = 'Ingen spelarstatistik ännu.';
      td.style.textAlign = 'left';
      td.style.color = 'var(--muted)';
      tr.appendChild(td);
      body.appendChild(tr);
      return;
    }

    for(const r of rows){
      const tr = document.createElement('tr');

      const tdName = document.createElement('td');
      const dot = document.createElement('span');
      dot.className = 'team-dot';
      dot.style.background = teamColorById(state, r.teamId);
      const name = document.createElement('span');
      name.textContent = r.name || '';
      tdName.appendChild(dot);
      tdName.appendChild(name);
      tr.appendChild(tdName);

      const cells = [
        r.SM, r.PV, r.SV, r.D, r.F, r.B, r.E, r.A, r.HIO, r.NF, r.LD,
        fmtPts(r.P), fmtPts(r.FF)
      ];

      cells.forEach(v => {
        const td = document.createElement('td');
        td.textContent = String(v ?? 0).replace('.', ',');
        tr.appendChild(td);
      });

      body.appendChild(tr);
    }
  }

  // ===== Sortering =====
  function makeTableSortable(table, defaultIndex, opts){
    if(!table) return;
    const thead = table.querySelector('thead');
    const tbody = table.querySelector('tbody');
    if(!thead || !tbody) return;

    const sortState = { index: (defaultIndex ?? 0), dir: -1 };
    const tiebreakOnP = !!opts?.tiebreakOnP;
    const mode = opts?.mode || '';
    const idx = opts?.idx || {};
    const cmpLocale = (a,b) => (a||'').localeCompare(b||'', 'sv');

    function getCellText(row, i){
      const td = row.children[i];
      return td ? (td.textContent || '').trim() : '';
    }
    function numFromCell(row, i){
      const s = getCellText(row, i).replace(',', '.');
      const n = Number(s);
      return isNaN(n) ? 0 : n;
    }
    function nameFromRow(row){ return getCellText(row, 0); }

    function cmpTeamByP(a,b,dir){
      const aP = numFromCell(a, idx.P);
      const bP = numFromCell(b, idx.P);
      if(bP !== aP) return dir * (aP - bP);

      const aPM = numFromCell(a, idx.PM);
      const bPM = numFromCell(b, idx.PM);
      if(bPM !== aPM) return dir * (aPM - bPM);

      const aSV = numFromCell(a, idx.SV);
      const bSV = numFromCell(b, idx.SV);
      if(bSV !== aSV) return dir * (aSV - bSV);

      return cmpLocale(nameFromRow(a), nameFromRow(b));
    }

    function cmpPlayerByP(a,b,dir){
      const aP = numFromCell(a, idx.P);
      const bP = numFromCell(b, idx.P);
      if(bP !== aP) return dir * (aP - bP);

      const aSV = numFromCell(a, idx.SV);
      const bSV = numFromCell(b, idx.SV);
      if(bSV !== aSV) return dir * (aSV - bSV);

      const aPV = numFromCell(a, idx.PV);
      const bPV = numFromCell(b, idx.PV);
      if(bPV !== aPV) return dir * (aPV - bPV);

      const aA = numFromCell(a, idx.A);
      const bA = numFromCell(b, idx.A);
      if(bA !== aA) return dir * (aA - bA);

      const aH = numFromCell(a, idx.HIO);
      const bH = numFromCell(b, idx.HIO);
      if(bH !== aH) return dir * (aH - bH);

      const aE = numFromCell(a, idx.E);
      const bE = numFromCell(b, idx.E);
      if(bE !== aE) return dir * (aE - bE);

      const aB = numFromCell(a, idx.B);
      const bB = numFromCell(b, idx.B);
      if(bB !== aB) return dir * (aB - bB);

      const aM = numFromCell(a, idx.PV) + numFromCell(a, idx.SV) + numFromCell(a, idx.D);
      const bM = numFromCell(b, idx.PV) + numFromCell(b, idx.SV) + numFromCell(b, idx.D);
      if(aM !== bM) return (-dir) * (aM - bM);

      return cmpLocale(nameFromRow(a), nameFromRow(b));
    }

    function sortRows(i, dir){
      const rows = Array.from(tbody.querySelectorAll('tr'));
      rows.sort((a,b) => {
        if(tiebreakOnP && i === idx.P){
          if(mode === 'team') return cmpTeamByP(a,b,dir);
          if(mode === 'player') return cmpPlayerByP(a,b,dir);
        }
        const av = getCellText(a, i);
        const bv = getCellText(b, i);

        const an = Number(av.replace(',', '.'));
        const bn = Number(bv.replace(',', '.'));
        const aIsNum = !isNaN(an);
        const bIsNum = !isNaN(bn);

        if(aIsNum && bIsNum) return dir * (an - bn);
        return dir * cmpLocale(av.toLowerCase(), bv.toLowerCase());
      });

      rows.forEach(r => tbody.appendChild(r));
    }

    Array.from(thead.querySelectorAll('th')).forEach((th, i) => {
      th.style.cursor = 'pointer';
      th.addEventListener('click', () => {
        if(sortState.index === i) sortState.dir *= -1;
        else { sortState.index = i; sortState.dir = -1; }
        sortRows(sortState.index, sortState.dir);
      });
    });

    sortRows(sortState.index, sortState.dir);
  }

  function enableStatTableSorting(){
    const lagTable = document.getElementById('lagStatsTable');
    makeTableSortable(lagTable, 7, {
      tiebreakOnP: true,
      mode: 'team',
      idx: { SM:1, PV:2, SV:3, PM:6, P:7 }
    });

    const playerTable = document.getElementById('playerStatsTable');
    makeTableSortable(playerTable, 12, {
      tiebreakOnP: true,
      mode: 'player',
      idx: { PV:2, SV:3, D:4, B:6, E:7, A:8, HIO:9, P:12 }
    });
  }

  // =========================
  // PUBLIK STATISTIK UI
  // =========================
  const statsTabLag = document.getElementById('tab-lagstats');
  const statsTabPlayer = document.getElementById('tab-playerstats');

  function setPublicStatsTab(which){
    const isLag = which === 'lag';

    if(statsTabLag){
      statsTabLag.classList.toggle('is-active', isLag);
      statsTabLag.setAttribute('aria-selected', isLag ? 'true' : 'false');
    }
    if(statsTabPlayer){
      statsTabPlayer.classList.toggle('is-active', !isLag);
      statsTabPlayer.setAttribute('aria-selected', !isLag ? 'true' : 'false');
    }

    const lagStatsBlock = document.getElementById('lagStatsBlock');
    const playerStatsBlock = document.getElementById('playerStatsBlock');
    if(lagStatsBlock) lagStatsBlock.style.display = isLag ? '' : 'none';
    if(playerStatsBlock) playerStatsBlock.style.display = isLag ? 'none' : '';
  }

  if(statsTabLag) statsTabLag.addEventListener('click', () => setPublicStatsTab('lag'));
  if(statsTabPlayer) statsTabPlayer.addEventListener('click', () => setPublicStatsTab('player'));

  async function renderPublicStats(){
    const state = await loadState();
    renderLagStatsMirror(state);
    renderPlayerStatsMirror(state);
    enableStatTableSorting();
  }

  // =========================
  // BOOT
  // =========================
  (async function boot(){
    await renderScorebar();
    await renderRoundsAndMatches();
    await renderPublicStats();
    setPublicStatsTab('lag');
  })();

})();
</script>
</body>
</html>
